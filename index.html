<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parfum Formulator</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main class="app-shell">
    <header class="hero">
  <div class="logo-box">
    <img src="logo-landscape.png" alt="Parfum Calculator Logo" class="site-logo" />
   <p class="tagline">
      Disegna, valuta e perfeziona le tue formule in modo intuitivo, sempre con
      una visione chiara della piramide olfattiva.
    </p>
  </div>
  <div class="hero-actions">
          <!-- üîπ LOGIN/LOGOUT PATCH -->
          <a
            id="loginLink"
            class="ghost-btn"
            href="./cloud/auth.html?return=https%3A%2F%2Florenvitale.github.io%2Fparfum-formulator%2F"
          >
            Login / Registrati
          </a>
          <span id="userBox" class="microcopy" style="display:none;"></span>
          <button id="logoutBtn" class="ghost-btn" type="button" style="display:none;">Logout</button>

          <!-- üîπ BOTTONI ORIGINALI -->
          <button id="newFormulaBtn" class="ghost-btn" type="button">Nuova formula</button>
          <button
            id="themeToggle"
            class="theme-toggle"
            type="button"
            role="switch"
            aria-checked="false"
            aria-label="Attiva modalit√† scura"
          >
            <span class="theme-toggle__icon" data-icon="sun" aria-hidden="true">‚òÄÔ∏è</span>
            <span class="theme-toggle__track" aria-hidden="true">
              <span class="theme-toggle__thumb"></span>
            </span>
            <span class="theme-toggle__icon" data-icon="moon" aria-hidden="true">üåô</span>
          </button>
        </div>
      </header>

      <!-- üîπ SEZIONE BATCH -->
      <section class="card" id="batchSection">
        <h2>Dosaggio Batch</h2>
        <div class="grid">
          <label class="field">
            <span>Nome Formula</span>
            <input id="formulaName" type="text" placeholder="Es. Aurora" />
          </label>
          <label class="field">
            <span>Tipologia</span>
            <select id="formulaType">
              <option value="EDT">Eau de Toilette</option>
              <option value="EDP" selected>Eau de Parfum</option>
              <option value="Parfum">Extrait / Parfum</option>
              <option value="Cologne">Cologne</option>
            </select>
          </label>
          <label class="field">
            <span>Lotto (g)</span>
            <input id="batchWeight" type="number" min="0" step="0.01" value="100" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Densit√† media (g/ml)</span>
            <input id="density" type="number" min="0.1" step="0.01" value="0.94" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Lotto (ml)</span>
            <output id="batchVolume">106.38</output>
          </label>
          <label class="field">
            <span>Lotto (gocce)</span>
            <output id="batchDrops">2127</output>
          </label>
        </div>
        <p class="microcopy">
          Conversioni basate su 1 ml = densit√† inserita e 20 gocce per millilitro.
        </p>
      </section>

      <!-- üîπ SEZIONE MATERIE PRIME -->
      <section class="card" id="materialsSection">
        <div class="section-header">
          <h2>Materie Prime</h2>
          <div class="section-actions">
            <button id="addMaterialBtn" type="button">Aggiungi nota</button>
            <button id="clearMaterialsBtn" class="ghost-btn" type="button">Svuota</button>
          </div>
        </div>
        <div class="materials-table" id="materialsTable"></div>
        <p class="microcopy">
          Inserisci le note aromatiche in grammi. Le conversioni in ml, gocce e percentuali
          sono calcolate automaticamente rispetto al lotto.
        </p>
      </section>

      <!-- üîπ SEZIONE ANALISI -->
     <section class="card" id="insightsSection">
  <h2>Analisi automatica</h2>
  <div class="insights-grid">
    <!-- Colonna 1 -->
    <div>
      <h3>Piramide olfattiva</h3>
      <ul id="pyramidList" class="pyramid"></ul>
    </div>

    <!-- Colonna 2 -->
    <div>
      <h3>Famiglia predominante</h3>
      <p id="familyBadge" class="badge">-</p>
    </div>

    <!-- Colonna 3 -->
    <div>
      <h3>Bilanciamento</h3>
      <div id="balanceGauge" class="gauge">
        <svg viewBox="0 0 200 120" class="gauge-svg" aria-label="Bilanciamento 1‚Äì10">
          <!-- arco di fondo -->
          <path class="gauge-bg" d="M10,110 A90,90 0 0 1 190,110" />
          <!-- arco valore -->
          <path class="gauge-arc" d="M10,110 A90,90 0 0 1 190,110" stroke-dasharray="0 999" />
          <!-- tacche -->
          <g class="gauge-ticks"></g>
          <!-- valore al centro -->
          <text id="gaugeValue" x="100" y="92" text-anchor="middle" class="gauge-value">-</text>
          <text x="100" y="112" text-anchor="middle" class="gauge-scale">1‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ10</text>
        </svg>
      </div>
      <!-- retro-compatibilit√† per app.js -->
      <p id="scoreValue" class="score" style="display:none">-</p>
    </div>

    <!-- Colonna 4 -->
    <div>
      <h3>Miglioramenti suggeriti</h3>
      <ul id="improvementList" class="suggestions"></ul>
    </div>
  </div>
</section>


      <!-- üîπ SEZIONE BIBLIOTECA -->
      <section class="card private" id="librarySection">
        <div class="section-header">
          <h2>Biblioteca formule</h2>
          <div class="section-actions private">
            <button id="saveFormulaBtn" type="button">Salva formula</button>
            <button id="exportFormulaBtn" class="ghost-btn" type="button">Esporta JSON</button>
          </div>
        </div>
        <div id="libraryList" class="library"></div>
      </section>

      <!-- üîπ SEZIONE EXPORT -->
      <section class="card export-card" id="exportSection">
        <h2>Esporta report</h2>
        <p class="microcopy">
          Scarica una copia strutturata della formula corrente per condividerla con il tuo team
          o archiviarla offline.
        </p>
        <div class="export-actions">
          <button id="exportExcelBtn" type="button">Esporta Excel</button>
          <button id="exportPdfBtn" class="ghost-btn" type="button">Esporta PDF</button>
        </div>
      </section>

      <footer class="microcopy">
        I dati restano sul tuo dispositivo (localStorage). Esporta per condividere o archiviare.
      </footer>
    </main>

    <!-- üîπ TEMPLATE -->
    <template id="materialRowTemplate">
      <div class="material-row">
        <div class="material-main">
          <label class="field">
            <span>Nota</span>
            <input type="text" class="note-input" list="noteLibrary" placeholder="Seleziona" />
          </label>
        </div>
        <div class="material-amounts">
          <label class="field">
            <span>Grammi</span>
            <input type="number" class="grams-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Millilitri</span>
            <input type="number" class="ml-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Gocce</span>
            <input type="number" class="drops-input" min="0" step="1" inputmode="numeric" />
          </label>
          <label class="field">
            <span>%</span>
            <input type="number" class="percent-input" min="0" max="100" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Diluizione (%)</span>
            <input type="number" class="dilution-input" min="0" max="100" step="0.1" inputmode="decimal" />
          </label>
        </div>
        <button type="button" class="icon-btn remove-btn" aria-label="Rimuovi nota">‚úï</button>
      </div>
    </template>

    <datalist id="noteLibrary"></datalist>

    <!-- JS originali -->
    <!-- === Tachimetro: API + render (mettere PRIMA di app.js) === -->
<script>
(function () {
  const SVG_NS = "http://www.w3.org/2000/svg";
  const svg = document.querySelector("#balanceGauge .gauge-svg");
  const arc = svg?.querySelector(".gauge-arc");
  const bg  = svg?.querySelector(".gauge-bg");
  const ticksGroup = svg?.querySelector(".gauge-ticks");
  const valueText  = svg?.querySelector("#gaugeValue");
  const scoreEl = document.getElementById("scoreValue"); // retro-compat con app.js

  if (!svg || !arc || !bg || !ticksGroup) return;

  // ======= Definizioni base (coerenti col path M10,110 A90,90 0 0 1 190,110)
  const CX = 100, CY = 110, R = 90;
  const BIG_TICK_LEN = 16;
  const SMALL_TICK_LEN = 10;

  // ======= Gradient blu dinamico (sfumatura coerente con --accent)
  const defs = document.createElementNS(SVG_NS, "defs");
  const grad = document.createElementNS(SVG_NS, "linearGradient");
  grad.setAttribute("id", "gaugeGrad");
  grad.setAttribute("x1", "0%");
  grad.setAttribute("y1", "100%");
  grad.setAttribute("x2", "100%");
  grad.setAttribute("y2", "0%");
  const stop1 = document.createElementNS(SVG_NS, "stop");
  const stop2 = document.createElementNS(SVG_NS, "stop");
  const cs = getComputedStyle(document.body);
  const accent = cs.getPropertyValue("--accent").trim() || "#4c5fd5";
  stop1.setAttribute("offset", "0%");
  stop1.setAttribute("stop-color", accent);
  stop1.setAttribute("stop-opacity", "0.35");
  stop2.setAttribute("offset", "100%");
  stop2.setAttribute("stop-color", accent);
  stop2.setAttribute("stop-opacity", "1");
  grad.appendChild(stop1);
  grad.appendChild(stop2);
  defs.appendChild(grad);

  // Glow leggerissimo (opzionale e sobrio)
  const glow = document.createElementNS(SVG_NS, "filter");
  glow.setAttribute("id", "gaugeGlow");
  const feDrop = document.createElementNS(SVG_NS, "feDropShadow");
  feDrop.setAttribute("dx", "0");
  feDrop.setAttribute("dy", "1");
  feDrop.setAttribute("stdDeviation", "1.2");
  feDrop.setAttribute("flood-color", accent);
  feDrop.setAttribute("flood-opacity", "0.25");
  glow.appendChild(feDrop);
  defs.appendChild(glow);

  svg.insertBefore(defs, svg.firstChild);
  arc.setAttribute("stroke", "url(#gaugeGrad)");
  arc.setAttribute("filter", "url(#gaugeGlow)");

  // ======= Helpers di geometria
  function polarPoint(angleDeg, radius) {
    const rad = (angleDeg * Math.PI) / 180;
    return [CX + Math.cos(rad) * radius, CY + Math.sin(rad) * radius];
  }

  function addTick(angleDeg, len, width, opacity) {
    const [x1, y1] = polarPoint(angleDeg, R);
    const [x2, y2] = polarPoint(angleDeg, R - len);
    const line = document.createElementNS(SVG_NS, "line");
    line.setAttribute("x1", x1.toFixed(2));
    line.setAttribute("y1", y1.toFixed(2));
    line.setAttribute("x2", x2.toFixed(2));
    line.setAttribute("y2", y2.toFixed(2));
    line.setAttribute("stroke", cs.getPropertyValue("--ink").trim() || "#111118");
    line.setAttribute("stroke-opacity", opacity);
    line.setAttribute("stroke-width", width);
    line.setAttribute("stroke-linecap", "round");
    ticksGroup.appendChild(line);
    return { x2, y2 };
  }

  function addLabel(text, angleDeg) {
    // Etichetta numerica leggermente pi√π interna
    const LABEL_R = R - BIG_TICK_LEN - 12; // spazio tra tacca e testo
    const [x, y] = polarPoint(angleDeg, LABEL_R);
    const t = document.createElementNS(SVG_NS, "text");
    t.textContent = text;
    t.setAttribute("x", x.toFixed(2));
    t.setAttribute("y", y.toFixed(2));
    t.setAttribute("text-anchor", "middle");
    t.setAttribute("dominant-baseline", "middle");
    t.setAttribute("class", "gauge-tick-label");
    ticksGroup.appendChild(t);
  }

  // ======= Tacche & Etichette
  ticksGroup.replaceChildren();
  // Maggiori: 10 posizioni 1..10 ‚Üí angolo 180¬∞..0¬∞
  for (let v = 1; v <= 10; v++) {
    const t = (v - 1) / 9;       // 0..1
    const angle = 180 - 180 * t; // 180¬∞ ‚Üí 0¬∞
    addTick(angle, BIG_TICK_LEN, 3, 0.85);
    addLabel(String(v), angle);
  }
  // Minori: 3 tra ogni maggiore (¬º, ¬Ω, ¬æ)
  for (let seg = 0; seg < 9; seg++) {
    for (let k = 1; k <= 3; k++) {
      const t = (seg + k / 4) / 9;
      const angle = 180 - 180 * t;
      addTick(angle, SMALL_TICK_LEN, 2, 0.35);
    }
  }

  // ======= Preparazione arco (per animazione via stroke-dasharray)
  const totalLen = bg.getTotalLength ? bg.getTotalLength() : 282.743; // fallback sensato
  arc.setAttribute("stroke-dasharray", `0 ${Math.ceil(totalLen)}`);

  // Mapping valore ‚Üí frazione 0..1
  function valueToFraction(n) {
    const val = Math.max(1, Math.min(10, Number(n) || 1));
    return (val - 1) / 9;
  }

  // Gradiente dinamico in blu (modula opacit√† e una leggera rotazione dell‚Äôasse)
  function tweakGradient(f) {
    // opacit√† ‚Äúsoft‚Äù aumenta col punteggio
    const soft = 0.25 + 0.5 * f; // 0.25..0.75
    stop1.setAttribute("stop-opacity", soft.toFixed(2));
    // leggero ‚Äútilt‚Äù del gradiente per dare vita all‚Äôarco
    grad.setAttribute("x2", `${80 + 20 * f}%`);
    grad.setAttribute("y2", `${(1 - f) * 20}%`);
  }

  // ======= API globale (usata da app.js via window.updateBalanceGauge / setBalanceScore)
  window.updateBalanceGauge = function (value) {
    const f = valueToFraction(value);
    const filled = (totalLen * f).toFixed(2);
    arc.setAttribute("stroke-dasharray", `${filled} ${Math.ceil(totalLen)}`);
    if (valueText) {
      const n = Math.max(1, Math.min(10, Math.round(Number(value) || 1)));
      valueText.textContent = String(n);
    }
    svg.setAttribute("aria-label", `Bilanciamento ${valueText ? valueText.textContent : value} su 10`);
    tweakGradient(f);
  };

  // ======= Primo allineamento
  const initial = (scoreEl?.textContent || "").trim().replace(",", ".");
  const n = Number(initial);
  window.updateBalanceGauge(Number.isFinite(n) ? n : 1);

  // ======= Adatta al cambio tema (per avere etichette/tacche leggibili)
  // In dark mode cambiano i CSS vars ‚Üí riapplico colori
  const mq = window.matchMedia?.("(prefers-color-scheme: dark)");
  function reapplyThemeColors() {
    const csRe = getComputedStyle(document.body);
    const ink = csRe.getPropertyValue("--ink").trim() || "#111118";
    const acc = csRe.getPropertyValue("--accent").trim() || "#4c5fd5";
    // aggiorna stroke tacche
    ticksGroup.querySelectorAll("line").forEach(l => l.setAttribute("stroke", ink));
    // aggiorna gradient
    stop1.setAttribute("stop-color", acc);
    stop2.setAttribute("stop-color", acc);
    // aggiorna glow
    svg.querySelector("#gaugeGlow feDropShadow")?.setAttribute("flood-color", acc);
  }
  mq?.addEventListener?.("change", reapplyThemeColors);
  // anche quando cambi tema con il toggle
  document.getElementById("themeToggle")?.addEventListener("click", () => {
    // attendo il repaint delle CSS vars
    setTimeout(reapplyThemeColors, 10);
  });
})();
</script>

    <script type="module" src="app.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://xbduxfvclbcdezegvpwl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiZHV4ZnZjbGJjZGV6ZWd2cHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODI5MzEsImV4cCI6MjA3NDk1ODkzMX0.l7d4dqzeoUx4isDRfG2riWDSkP6n2mtaD2kEHtyIudU";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // helper per mostrare/nascondere sezioni private e pulire liste
  function applyPrivacyUI(isLoggedIn) {
    const privates = document.querySelectorAll('.private');
    privates.forEach(el => el.style.display = isLoggedIn ? '' : 'none');
    if (!isLoggedIn) {
      // svuota elenco formule in UI
      document.getElementById('libraryList')?.replaceChildren();
    }
  }

  (async () => {
    const { data: { session } } = await supa.auth.getSession();
    const isLogged = !!session?.user;

    // UI login/logout
    const loginLink = document.getElementById('loginLink');
    const userBox   = document.getElementById('userBox');
    const logoutBtn = document.getElementById('logoutBtn');
    if (isLogged) {
      if (loginLink) loginLink.style.display = 'none';
      if (userBox)   { userBox.style.display = 'inline'; userBox.textContent = `Ciao, ${session.user.email}`; }
      if (logoutBtn) logoutBtn.style.display = 'inline';
    } else {
      if (loginLink) loginLink.style.display = 'inline-block';
      if (userBox)   userBox.style.display = 'none';
      if (logoutBtn) logoutBtn.style.display = 'none';
    }

    // Privacy: mostra/nascondi aree sensibili
    applyPrivacyUI(isLogged);

    // Se cambia lo stato (login/logout da un‚Äôaltra pagina), aggiorna
    supa.auth.onAuthStateChange((_e, sess) => applyPrivacyUI(!!sess?.user));
  })();

  // Logout con pulizia ‚Äúriservata‚Äù
  document.getElementById('logoutBtn')?.addEventListener('click', async () => {
    try {
      await supa.auth.signOut();

      // cancella token supabase locale
      sessionStorage.clear();
      localStorage.removeItem("sb-" + SUPABASE_URL.match(/https:\/\/(.*?)\./)[1] + "-auth-token");

      // üîí cancella anche dati locali del tool (prefisso tuo)
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith('parfum-formulator:')) localStorage.removeItem(k);
      });

      // nascondi sezioni private + svuota liste
      applyPrivacyUI(false);

      // toast
      const toast = document.createElement("div");
      toast.textContent = "Sei uscito ‚úÖ";
      Object.assign(toast.style, {
        position: "fixed", bottom: "20px", right: "20px",
        background: "#222", color: "#fff", padding: "10px 16px",
        borderRadius: "8px", fontSize: "0.9rem", zIndex: "9999"
      });
      document.body.appendChild(toast);

      setTimeout(() => { location.href = 'https://lorenvitale.github.io/parfum-formulator/'; }, 1000);
    } catch (e) {
      location.href = 'https://lorenvitale.github.io/parfum-formulator/';
    }
  });
</script>
  </body>
</html>
