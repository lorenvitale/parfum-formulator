<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parfum Formulator</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main class="app-shell">
      <header class="hero">
        <div>
          <h1>Parfum Formulator</h1>
          <p>
            Disegna, valuta e perfeziona le tue formule in modo intuitivo, sempre con
            una visione chiara della piramide olfattiva.
          </p>
        </div>
        <div class="hero-actions">
          <!-- Login/Logout -->
          <a
            id="loginLink"
            class="ghost-btn"
            href="./cloud/auth.html?return=https%3A%2F%2Florenvitale.github.io%2Fparfum-formulator%2F"
          >
            Login / Registrati
          </a>
          <span id="userBox" class="microcopy" style="display:none;"></span>
          <button id="logoutBtn" class="ghost-btn" type="button" style="display:none;">Logout</button>

          <!-- Altri pulsanti -->
          <button id="newFormulaBtn" class="ghost-btn" type="button">Nuova formula</button>
          <button
            id="themeToggle"
            class="theme-toggle"
            type="button"
            role="switch"
            aria-checked="false"
            aria-label="Attiva modalit√† scura"
          >
            <span class="theme-toggle__icon" data-icon="sun" aria-hidden="true">‚òÄÔ∏è</span>
            <span class="theme-toggle__track" aria-hidden="true">
              <span class="theme-toggle__thumb"></span>
            </span>
            <span class="theme-toggle__icon" data-icon="moon" aria-hidden="true">üåô</span>
          </button>
        </div>
      </header>

      <!-- SEZIONI ESISTENTI DEL TUO SITO -->
      <section class="card" id="batchSection">
        <h2>Dosaggio Batch</h2>
        <div class="grid">
          <label class="field">
            <span>Nome Formula</span>
            <input id="formulaName" type="text" placeholder="Es. Aurora" />
          </label>
          <label class="field">
            <span>Tipologia</span>
            <select id="formulaType">
              <option value="EDT">Eau de Toilette</option>
              <option value="EDP" selected>Eau de Parfum</option>
              <option value="Parfum">Extrait / Parfum</option>
              <option value="Cologne">Cologne</option>
            </select>
          </label>
          <label class="field">
            <span>Lotto (g)</span>
            <input id="batchWeight" type="number" min="0" step="0.01" value="100" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Densit√† media (g/ml)</span>
            <input id="density" type="number" min="0.1" step="0.01" value="0.94" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Lotto (ml)</span>
            <output id="batchVolume">106.38</output>
          </label>
          <label class="field">
            <span>Lotto (gocce)</span>
            <output id="batchDrops">2127</output>
          </label>
        </div>
        <p class="microcopy">
          Conversioni basate su 1 ml = densit√† inserita e 20 gocce per millilitro.
        </p>
      </section>

      <!-- altre sezioni gi√† presenti... -->

      <footer class="microcopy">
        I dati restano sul tuo dispositivo (localStorage). Esporta per condividere o archiviare.
      </footer>
    </main>

    <!-- Template righe tabella -->
    <template id="materialRowTemplate">
      <div class="material-row">
        <div class="material-main">
          <label class="field">
            <span>Nota</span>
            <input type="text" class="note-input" list="noteLibrary" placeholder="Seleziona" />
          </label>
        </div>
        <div class="material-amounts">
          <label class="field">
            <span>Grammi</span>
            <input type="number" class="grams-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Millilitri</span>
            <input type="number" class="ml-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Gocce</span>
            <input type="number" class="drops-input" min="0" step="1" inputmode="numeric" />
          </label>
          <label class="field">
            <span>%</span>
            <input type="number" class="percent-input" min="0" max="100" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Diluizione (%)</span>
            <input type="number" class="dilution-input" min="0" max="100" step="0.1" inputmode="decimal" />
          </label>
        </div>
        <button type="button" class="icon-btn remove-btn" aria-label="Rimuovi nota">‚úï</button>
      </div>
    </template>

    <datalist id="noteLibrary"></datalist>

    <!-- JS principali -->
    <script type="module" src="app.js"></script>

    <!-- Supabase auth script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://xbduxfvclbcdezegvpwl.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiZHV4ZnZjbGJjZGV6ZWd2cHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODI5MzEsImV4cCI6MjA3NDk1ODkzMX0.l7d4dqzeoUx4isDRfG2riWDSkP6n2mtaD2kEHtyIudU";

      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      (async () => {
        const { data: { session } } = await supa.auth.getSession();
        const loginLink = document.getElementById('loginLink');
        const userBox   = document.getElementById('userBox');
        const logoutBtn = document.getElementById('logoutBtn');

        if (session?.user) {
          if (loginLink) loginLink.style.display = 'none';
          if (userBox)   { userBox.style.display = 'inline'; userBox.textContent = `Ciao, ${session.user.email}`; }
          if (logoutBtn) logoutBtn.style.display = 'inline';
        }
      })();

      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
          await supa.auth.signOut();
          sessionStorage.clear();
          localStorage.removeItem("sb-" + SUPABASE_URL.match(/https:\/\/(.*?)\./)[1] + "-auth-token");

          // toast
          const toast = document.createElement("div");
          toast.textContent = "Sei uscito ‚úÖ";
          Object.assign(toast.style, {
            position: "fixed", bottom: "20px", right: "20px",
            background: "#222", color: "#fff", padding: "10px 16px",
            borderRadius: "8px", fontSize: "0.9rem", zIndex: "9999"
          });
          document.body.appendChild(toast);

          setTimeout(() => { location.href = 'https://lorenvitale.github.io/parfum-formulator/'; }, 1200);
        } catch (e) {
          console.error("Logout error:", e);
          location.href = 'https://lorenvitale.github.io/parfum-formulator/';
        }
      });
    </script>
  </body>
</html>
