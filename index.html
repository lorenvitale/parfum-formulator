<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parfum Formulator</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main class="app-shell">
    <header class="hero">
  <div class="logo-box">
    <img src="logo-landscape.png" alt="Parfum Calculator Logo" class="site-logo" />
   <p class="tagline">
      Disegna, valuta e perfeziona le tue formule in modo intuitivo, sempre con
      una visione chiara della piramide olfattiva.
    </p>
  </div>
  <div class="hero-actions">
  <!-- ‚ûï AGGIUNTA -->
  <button id="importBtn" class="ghost-btn" type="button">Importa ricetta</button>
  <input id="importFile" type="file" accept="application/json,.json" style="display:none;" />
  <!-- üîπ LOGIN/LOGOUT PATCH -->
  <a
    id="loginLink"
    class="ghost-btn"
    href="./cloud/auth.html?return=https%3A%2F%2Florenvitale.github.io%2Fparfum-formulator%2F"
  >
    Login / Registrati
  </a>
  <span id="userBox" class="microcopy" style="display:none;"></span>
  <button id="logoutBtn" class="ghost-btn" type="button" style="display:none;">Logout</button>

  <!-- üîπ BOTTONI ORIGINALI -->
  <button id="newFormulaBtn" class="ghost-btn" type="button">Nuova formula</button>
  <button
    id="themeToggle"
    class="theme-toggle"
    type="button"
    role="switch"
    aria-checked="false"
    aria-label="Attiva modalit√† scura"
  >
    <span class="theme-toggle__icon" data-icon="sun" aria-hidden="true">‚òÄÔ∏è</span>
    <span class="theme-toggle__track" aria-hidden="true">
      <span class="theme-toggle__thumb"></span>
    </span>
    <span class="theme-toggle__icon" data-icon="moon" aria-hidden="true">üåô</span>
  </button>
</div>

      </header>
      <!-- üîπ WIZARD STEPPER -->
<nav class="stepper">
  <ol class="stepper-list">
    <li data-step="1"><span>1</span><em>Batch</em></li>
    <li data-step="2"><span>2</span><em>Note</em></li>
    <li data-step="3"><span>3</span><em>Piramide</em></li>
    <li data-step="4"><span>4</span><em>Valutazione</em></li>
    <li data-step="5"><span>5</span><em>Export</em></li>
  </ol>
  <div class="stepper-actions">
    <button id="prevStep" class="ghost-btn" type="button">Indietro</button>
    <button id="nextStep" type="button">Avanti</button>
  </div>
</nav>


      <!-- üîπ SEZIONE BATCH -->
      <section class="card step" data-step="1" id="batchSection">
        <h2>Dosaggio Batch</h2>
        <div class="grid">
          <label class="field">
            <span>Nome Formula</span>
            <input id="formulaName" type="text" placeholder="Es. Aurora" />
          </label>
          <label class="field">
            <span>Tipologia</span>
            <select id="formulaType">
              <option value="EDT">Eau de Toilette</option>
              <option value="EDP" selected>Eau de Parfum</option>
              <option value="Parfum">Extrait / Parfum</option>
              <option value="Cologne">Cologne</option>
            </select>
          </label>
          <label class="field">
            <span>Lotto (g)</span>
            <input id="batchWeight" type="number" min="0" step="0.01" value="100" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Densit√† media (g/ml)</span>
            <input id="density" type="number" min="0.1" step="0.01" value="0.94" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Lotto (ml)</span>
            <output id="batchVolume">106.38</output>
          </label>
          <label class="field">
            <span>Lotto (gocce)</span>
            <output id="batchDrops">2127</output>
          </label>
        </div>
        <p class="microcopy">
          Conversioni basate su 1 ml = densit√† inserita e 20 gocce per millilitro.
        </p>
      </section>

      <!-- üîπ SEZIONE MATERIE PRIME -->
      <section class="card step" data-step="2" id="materialsSection">
        <div class="section-header">
          <h2>Materie Prime</h2>
          <div class="section-actions">
            <button id="browseCatalogBtn" type="button" class="ghost-btn">Sfoglia catalogo</button>
            <button id="addMaterialBtn" type="button">Aggiungi nota</button>
            <button id="clearMaterialsBtn" class="ghost-btn" type="button">Svuota</button>
          </div>
        </div>
        <div class="materials-table" id="materialsTable"></div>
        <p class="microcopy">
          Inserisci le note aromatiche in grammi. Le conversioni in ml, gocce e percentuali
          sono calcolate automaticamente rispetto al lotto.
        </p>
      </section>
       <section id="batch-mixer" class="bm-wrap">
  <header class="bm-head">
    <h2>Batch Mixer</h2>
    <p id="bm-range-hint" class="bm-hint"></p>
  </header>

  <div class="bm-grid">
    <div class="bm-field">
      <label for="bm-batch">Batch (mL)</label>
      <input id="bm-batch" type="number" min="1" step="0.1" value="10" />
    </div>

    <div class="bm-field">
      <label>Tipologia</label>
      <div id="bm-types" class="bm-types">
        <button data-type="EDC">EDC</button>
        <button data-type="EDT">EDT</button>
        <button data-type="EDP" class="active">EDP</button>
        <button data-type="Extrait">Extrait</button>
      </div>
      <small class="bm-hint">Range consigliato visibile sulla barra</small>
    </div>

    <div class="bm-meter">
      <div class="bm-line">
        <div id="bm-bar-fill" class="bm-bar"></div>
      </div>
      <div class="bm-meter-row">
        <span>Concentrato</span>
        <span id="bm-conc">0.00 mL (0%)</span>
      </div>
      <div class="bm-meter-row small">
        <span>Totale</span>
        <span id="bm-total">0.00 / 10 mL</span>
      </div>
    </div>
  </div>

  <hr class="bm-sep" />

  <div class="bm-add">
    <div class="bm-add-left">
      <label for="bm-note-name">Aggiungi nota</label>
      <input id="bm-note-name" placeholder="Es. Iso E Super, Ambroxan, Bergamotto‚Ä¶" />
    </div>
    <div class="bm-add-right">
      <label for="bm-note-ml">mL</label>
      <input id="bm-note-ml" type="number" step="0.05" min="0" value="0.10" />
    </div>
    <button id="bm-add-note" class="bm-btn">Aggiungi</button>
  </div>

  <div class="bm-table">
    <div class="bm-thead">
      <div>Nome</div><div>Tipo</div><div>mL</div><div>Azioni</div>
    </div>
    <table>
      <tbody id="bm-rows"></tbody>
    </table>
  </div>

  <div class="bm-footer">
    <div>Rimanenti da riempire: <b id="bm-remaining">0.00 mL</b></div>
    <button id="bm-open-diluent" class="bm-btn bm-pipette">
      <svg viewBox="0 0 24 24" class="bm-icon"><path d="M14 4l6 6-8 8H6v-6zM4 20h16"/></svg>
      Aggiungi diluente
    </button>
  </div>
</section>
      <!-- Modal -->
  <div id="bm-modal" class="bm-modal">
    <div id="bm-modal-mask" class="bm-mask"></div>
    <div class="bm-dialog">
      <h3>Completa il batch con diluenti</h3>
      <p class="bm-sub">Scegli uno o pi√π diluenti. Puoi riempire automaticamente il residuo o ripartire a percentuali.</p>

      <div class="bm-autofill">
        <label class="bm-switch">
          <input type="checkbox" id="bm-autofill" checked />
          <span>Riempi automaticamente il residuo</span>
        </label>
      </div>

      <div id="bm-diluent-grid" class="bm-dil-grid"></div>

      <div id="bm-split-box" class="bm-split" style="display:none">
        <div class="bm-split-top">
          <strong>Ripartizione percentuale</strong>
          <button id="bm-even" class="bm-btn small">Distribuisci in parti uguali</button>
        </div>
        <div id="bm-split-rows"></div>
        <small class="bm-note">Le percentuali verranno normalizzate al 100% alla conferma.</small>
      </div>

      <div class="bm-actions">
        <button id="bm-cancel" class="bm-btn ghost">Annulla</button>
        <button id="bm-confirm" class="bm-btn">Conferma e riempi</button>
      </div>
    </div>
  </div>
</section>


      <!-- üîπ STEP 3 ‚Äî PIRAMIDE OLFATTIVA -->
<section class="card step" data-step="3" id="pyramidSection">
  <h2>Piramide olfattiva</h2>
  <ul id="pyramidList" class="pyramid"></ul>
</section>

<!-- üîπ STEP 4 ‚Äî VALUTAZIONE -->
<section class="card step" data-step="4" id="evaluationSection">
  <h2>Valutazione</h2>
  <div class="insights-grid">
    <div>
      <h3>Famiglia predominante</h3>
      <p id="familyBadge" class="badge">-</p>
    </div>
    <div>
      <h3>Bilanciamento</h3>
      <div id="balanceGauge" class="gauge">
        <svg viewBox="0 0 200 120" class="gauge-svg" aria-label="Bilanciamento 1‚Äì10">
          <!-- arco di fondo -->
          <path class="gauge-bg" d="M10,110 A90,90 0 0 1 190,110" />
          <!-- arco valore -->
          <path class="gauge-arc" d="M10,110 A90,90 0 0 1 190,110" stroke-dasharray="0 999" />
          <!-- tacche -->
          <g class="gauge-ticks"></g>
          <!-- valore al centro -->
          <text id="gaugeValue" x="100" y="92" text-anchor="middle" class="gauge-value">-</text>
        </svg>
      </div>
      <p id="scoreValue" class="score" style="display:none">-</p>
    </div>
    <div>
      <h3>Miglioramenti suggeriti</h3>
      <ul id="improvementList" class="suggestions"></ul>
    </div>
  </div>
</section>

      <!-- üîπ STEP 5 ‚Äî SALVATAGGIO & EXPORT (contenitore unico) -->
<section class="step" data-step="5" id="finalStep">

  <!-- üîπ SEZIONE BIBLIOTECA -->
  <section class="card private" id="librarySection">
    <div class="section-header">
      <h2>Biblioteca formule</h2>
      <div class="section-actions private">
        <button id="saveFormulaBtn" type="button">Salva formula</button>
        <button id="exportFormulaBtn" class="ghost-btn" type="button">Esporta JSON</button>
      </div>
    </div>
    <div id="libraryList" class="library"></div>
  </section>

  <!-- üîπ SEZIONE EXPORT -->
  <section class="card export-card" id="exportSection">
    <h2>Esporta report</h2>
    <p class="microcopy">
      Scarica una copia strutturata della formula corrente per condividerla con il tuo team
      o archiviarla offline.
    </p>
    <div class="export-actions">
      <button id="exportExcelBtn" type="button">Esporta Excel</button>
      <button id="exportPdfBtn" class="ghost-btn" type="button">Esporta PDF</button>
    </div>
  </section>

</section>
      <footer class="microcopy">
        I dati restano sul tuo dispositivo (localStorage). Esporta per condividere o archiviare.
      </footer>
      <!-- Modal Catalogo Master -->
<div id="catalogModal" class="modal" aria-hidden="true">
  <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="catalogTitle">
    <header class="modal__header">
      <h3 id="catalogTitle">Catalogo materie prime</h3>
      <button type="button" class="icon-btn" id="catalogCloseBtn" aria-label="Chiudi">‚úï</button>
    </header>
    <div class="modal__toolbar">
      <input id="catalogSearch" type="search" placeholder="Cerca nome o famiglia‚Ä¶" />
      <select id="catalogGroup">
        <option value="">Tutti i gruppi</option>
        <option>Olio essenziale</option>
        <option>Assoluta</option>
        <option>CO2</option>
        <option>Tintura</option>
        <option>Burro/Cera</option>
        <option>Acqua aromatica</option>
        <option>Solvente</option>
      </select>
    </div>
    <div id="catalogList" class="modal__list"></div>
    <footer class="modal__footer">
      <button type="button" class="ghost-btn" id="catalogCloseBtn2">Chiudi</button>
    </footer>
  </div>
</div>
      <section id="missingNotesBlock" class="missing-notes">
  <button id="requestNotesCta" type="button" class="ghost-btn small">
    Non trovi qualche nota? Scrivici e la aggiungeremo nella prossima patch mensile
  </button>

  <div id="requestNotesForm" class="missing-notes__form" hidden>
    <input
      id="requestNotesInput"
      type="text"
      placeholder="Scrivi qui le note che ti mancano (separate da virgola)‚Ä¶"
      autocomplete="off"
    />
    <button id="requestNotesSend" type="button">Invia</button>
    <span id="requestNotesFeedback" class="microcopy" aria-live="polite"></span>
  </div>
</section>


    </main>

    <!-- üîπ TEMPLATE -->
    <template id="materialRowTemplate">
      <div class="material-row">
        <div class="material-main">
          <label class="field">
            <span>Nota</span>
            <input type="text" class="note-input" list="noteLibrary" placeholder="Seleziona" />
          </label>
        </div>
        <div class="material-amounts">
          <label class="field">
            <span>Grammi</span>
            <input type="number" class="grams-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Millilitri</span>
            <input type="number" class="ml-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Gocce</span>
            <input type="number" class="drops-input" min="0" step="1" inputmode="numeric" />
          </label>
          <label class="field">
            <span>%</span>
            <input type="number" class="percent-input" min="0" max="100" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Diluizione (%)</span>
            <input type="number" class="dilution-input" min="0" max="100" step="0.1" inputmode="decimal" />
          </label>
        </div>
        <button type="button" class="icon-btn remove-btn" aria-label="Rimuovi nota">‚úï</button>
      </div>
    </template>

    <datalist id="noteLibrary"></datalist>

    <!-- JS originali -->
    <!-- === Tachimetro: API + render (mettere PRIMA di app.js) === -->
<script>
(function () {
  const SVG_NS = "http://www.w3.org/2000/svg";
  const svg = document.querySelector("#balanceGauge .gauge-svg");
  const arc = svg?.querySelector(".gauge-arc");
  const bg  = svg?.querySelector(".gauge-bg");
  const ticksGroup = svg?.querySelector(".gauge-ticks");
  const valueText  = svg?.querySelector("#gaugeValue");
  const scoreEl = document.getElementById("scoreValue"); // retro-compat con app.js

  if (!svg || !arc || !bg || !ticksGroup) return;

  // ======= Definizioni base (coerenti col path M10,110 A90,90 0 0 1 190,110)
  const CX = 100, CY = 110, R = 90;
  const BIG_TICK_LEN = 16;
  const SMALL_TICK_LEN = 10;

  // ======= Gradient blu dinamico (sfumatura coerente con --accent)
  const defs = document.createElementNS(SVG_NS, "defs");
  const grad = document.createElementNS(SVG_NS, "linearGradient");
  grad.setAttribute("id", "gaugeGrad");
  grad.setAttribute("x1", "0%");
  grad.setAttribute("y1", "100%");
  grad.setAttribute("x2", "100%");
  grad.setAttribute("y2", "0%");
  const stop1 = document.createElementNS(SVG_NS, "stop");
  const stop2 = document.createElementNS(SVG_NS, "stop");
  const cs = getComputedStyle(document.body);
  const accent = cs.getPropertyValue("--accent").trim() || "#4c5fd5";
  stop1.setAttribute("offset", "0%");
  stop1.setAttribute("stop-color", accent);
  stop1.setAttribute("stop-opacity", "0.35");
  stop2.setAttribute("offset", "100%");
  stop2.setAttribute("stop-color", accent);
  stop2.setAttribute("stop-opacity", "1");
  grad.appendChild(stop1);
  grad.appendChild(stop2);
  defs.appendChild(grad);

  // Glow leggerissimo (opzionale e sobrio)
  const glow = document.createElementNS(SVG_NS, "filter");
  glow.setAttribute("id", "gaugeGlow");
  const feDrop = document.createElementNS(SVG_NS, "feDropShadow");
  feDrop.setAttribute("dx", "0");
  feDrop.setAttribute("dy", "1");
  feDrop.setAttribute("stdDeviation", "1.2");
  feDrop.setAttribute("flood-color", accent);
  feDrop.setAttribute("flood-opacity", "0.25");
  glow.appendChild(feDrop);
  defs.appendChild(glow);

  svg.insertBefore(defs, svg.firstChild);
  arc.setAttribute("stroke", "url(#gaugeGrad)");
  arc.setAttribute("filter", "url(#gaugeGlow)");

  // ======= Helpers di geometria
  function polarPoint(angleDeg, radius) {
    const rad = (angleDeg * Math.PI) / 180;
    return [CX + Math.cos(rad) * radius, CY + Math.sin(rad) * radius];
  }

  function addTick(angleDeg, len, width, opacity) {
    const [x1, y1] = polarPoint(angleDeg, R);
    const [x2, y2] = polarPoint(angleDeg, R - len);
    const line = document.createElementNS(SVG_NS, "line");
    line.setAttribute("x1", x1.toFixed(2));
    line.setAttribute("y1", y1.toFixed(2));
    line.setAttribute("x2", x2.toFixed(2));
    line.setAttribute("y2", y2.toFixed(2));
    line.setAttribute("stroke", cs.getPropertyValue("--ink").trim() || "#111118");
    line.setAttribute("stroke-opacity", opacity);
    line.setAttribute("stroke-width", width);
    line.setAttribute("stroke-linecap", "round");
    ticksGroup.appendChild(line);
    return { x2, y2 };
  }

  function addLabel(text, angleDeg) {
    // Etichetta numerica leggermente pi√π interna
    const LABEL_R = R - BIG_TICK_LEN - 12; // spazio tra tacca e testo
    const [x, y] = polarPoint(angleDeg, LABEL_R);
    const t = document.createElementNS(SVG_NS, "text");
    t.textContent = text;
    t.setAttribute("x", x.toFixed(2));
    t.setAttribute("y", y.toFixed(2));
    t.setAttribute("text-anchor", "middle");
    t.setAttribute("dominant-baseline", "middle");
    t.setAttribute("class", "gauge-tick-label");
    ticksGroup.appendChild(t);
  }

  // ======= Tacche & Etichette
  ticksGroup.replaceChildren();
  // Maggiori: 10 posizioni 1..10 ‚Üí angolo 180¬∞..0¬∞
  for (let v = 1; v <= 10; v++) {
    const t = (v - 1) / 9;       // 0..1
    const angle = 180 - 180 * t; // 180¬∞ ‚Üí 0¬∞
    addTick(angle, BIG_TICK_LEN, 3, 0.85);
    addLabel(String(v), angle);
  }
  // Minori: 3 tra ogni maggiore (¬º, ¬Ω, ¬æ)
  for (let seg = 0; seg < 9; seg++) {
    for (let k = 1; k <= 3; k++) {
      const t = (seg + k / 4) / 9;
      const angle = 180 - 180 * t;
      addTick(angle, SMALL_TICK_LEN, 2, 0.35);
    }
  }

  // ======= Preparazione arco (per animazione via stroke-dasharray)
  const totalLen = bg.getTotalLength ? bg.getTotalLength() : 282.743; // fallback sensato
  arc.setAttribute("stroke-dasharray", `0 ${Math.ceil(totalLen)}`);

  // Mapping valore ‚Üí frazione 0..1
  function valueToFraction(n) {
    const val = Math.max(1, Math.min(10, Number(n) || 1));
    return (val - 1) / 9;
  }

  // Gradiente dinamico in blu (modula opacit√† e una leggera rotazione dell‚Äôasse)
  function tweakGradient(f) {
    // opacit√† ‚Äúsoft‚Äù aumenta col punteggio
    const soft = 0.25 + 0.5 * f; // 0.25..0.75
    stop1.setAttribute("stop-opacity", soft.toFixed(2));
    // leggero ‚Äútilt‚Äù del gradiente per dare vita all‚Äôarco
    grad.setAttribute("x2", `${80 + 20 * f}%`);
    grad.setAttribute("y2", `${(1 - f) * 20}%`);
  }

  // ======= API globale (usata da app.js via window.updateBalanceGauge / setBalanceScore)
  window.updateBalanceGauge = function (value) {
    const f = valueToFraction(value);
    const filled = (totalLen * f).toFixed(2);
    arc.setAttribute("stroke-dasharray", `${filled} ${Math.ceil(totalLen)}`);
    if (valueText) {
      const n = Math.max(1, Math.min(10, Math.round(Number(value) || 1)));
      valueText.textContent = String(n);
    }
    svg.setAttribute("aria-label", `Bilanciamento ${valueText ? valueText.textContent : value} su 10`);
    tweakGradient(f);
  };

  // ======= Primo allineamento
  const initial = (scoreEl?.textContent || "").trim().replace(",", ".");
  const n = Number(initial);
  window.updateBalanceGauge(Number.isFinite(n) ? n : 1);

  // ======= Adatta al cambio tema (per avere etichette/tacche leggibili)
  // In dark mode cambiano i CSS vars ‚Üí riapplico colori
  const mq = window.matchMedia?.("(prefers-color-scheme: dark)");
  function reapplyThemeColors() {
    const csRe = getComputedStyle(document.body);
    const ink = csRe.getPropertyValue("--ink").trim() || "#111118";
    const acc = csRe.getPropertyValue("--accent").trim() || "#4c5fd5";
    // aggiorna stroke tacche
    ticksGroup.querySelectorAll("line").forEach(l => l.setAttribute("stroke", ink));
    // aggiorna gradient
    stop1.setAttribute("stop-color", acc);
    stop2.setAttribute("stop-color", acc);
    // aggiorna glow
    svg.querySelector("#gaugeGlow feDropShadow")?.setAttribute("flood-color", acc);
  }
  mq?.addEventListener?.("change", reapplyThemeColors);
  // anche quando cambi tema con il toggle
  document.getElementById("themeToggle")?.addEventListener("click", () => {
    // attendo il repaint delle CSS vars
    setTimeout(reapplyThemeColors, 10);
  });
})();
</script>

    <script type="module" src="app.js"></script>
    <script>
(function () {
  const stepsEls = Array.from(document.querySelectorAll('.step'));
  const stepperItems = Array.from(document.querySelectorAll('.stepper-list li'));
  const prevBtn = document.getElementById('prevStep');
  const nextBtn = document.getElementById('nextStep');

  function clamp(n) { return Math.max(1, Math.min(5, n|0)); }
  function parseStep() {
    const m = location.hash.match(/step\/(\d+)/);
    return clamp(m ? Number(m[1]) : 1);
  }
  function goTo(n) { location.hash = `#/step/${clamp(n)}`; }

  function markStepper(n) {
    stepperItems.forEach(li => li.removeAttribute('aria-current'));
    const active = stepperItems.find(li => Number(li.dataset.step) === n);
    active?.setAttribute('aria-current','step');
  }

  function show(n) {
    document.documentElement.setAttribute('data-step', String(n));
    prevBtn.disabled = (n === 1);
    nextBtn.disabled = (n === 5);
    markStepper(n);
  }

  function canLeave(step) {
    const api = window.__wizardApi;
    if (!api) return true;
    if (step === 1) return api.getBatchWeight() > 0;
    if (step === 2) return (api.state.materials?.length || 0) > 0;
    return true;
  }

  function maybeRefresh(n) {
    const api = window.__wizardApi; if (!api) return;
    if (n === 3 || n === 4) {
      api.hydrate();
      api.updateBatch();
      api.updateInsights();
    }
  }

  stepperItems.forEach(li => {
    li.addEventListener('click', () => {
      const target = Number(li.dataset.step);
      const current = parseStep();
      if (target <= current || canLeave(current)) goTo(target);
    });
  });

  prevBtn?.addEventListener('click', () => goTo(parseStep() - 1));
  nextBtn?.addEventListener('click', () => {
    const cur = parseStep();
    if (canLeave(cur)) goTo(cur + 1);
  });

  window.addEventListener('hashchange', () => {
    const n = parseStep();
    show(n);
    maybeRefresh(n);
  });

  if (!location.hash) location.hash = '#/step/1';
  const start = parseStep();
  show(start);
  maybeRefresh(start);
})();
</script>

   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://xbduxfvclbcdezegvpwl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiZHV4ZnZjbGJjZGV6ZWd2cHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODI5MzEsImV4cCI6MjA3NDk1ODkzMX0.l7d4dqzeoUx4isDRfG2riWDSkP6n2mtaD2kEHtyIudU";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // helper per mostrare/nascondere sezioni private e pulire liste
  function applyPrivacyUI(isLoggedIn) {
    const privates = document.querySelectorAll('.private');
    privates.forEach(el => el.style.display = isLoggedIn ? '' : 'none');
    if (!isLoggedIn) {
      // svuota elenco formule in UI
      document.getElementById('libraryList')?.replaceChildren();
    }
  }

  (async () => {
    const { data: { session } } = await supa.auth.getSession();
    const isLogged = !!session?.user;

    // UI login/logout
    const loginLink = document.getElementById('loginLink');
    const userBox   = document.getElementById('userBox');
    const logoutBtn = document.getElementById('logoutBtn');
    if (isLogged) {
      if (loginLink) loginLink.style.display = 'none';
      if (userBox)   { userBox.style.display = 'inline'; userBox.textContent = `Ciao, ${session.user.email}`; }
      if (logoutBtn) logoutBtn.style.display = 'inline';
    } else {
      if (loginLink) loginLink.style.display = 'inline-block';
      if (userBox)   userBox.style.display = 'none';
      if (logoutBtn) logoutBtn.style.display = 'none';
    }

    // Privacy: mostra/nascondi aree sensibili
    applyPrivacyUI(isLogged);

    // Se cambia lo stato (login/logout da un‚Äôaltra pagina), aggiorna
    supa.auth.onAuthStateChange((_e, sess) => applyPrivacyUI(!!sess?.user));
  })();

  // Logout con pulizia ‚Äúriservata‚Äù
  document.getElementById('logoutBtn')?.addEventListener('click', async () => {
    try {
      await supa.auth.signOut();

      // cancella token supabase locale
      sessionStorage.clear();
      localStorage.removeItem("sb-" + SUPABASE_URL.match(/https:\/\/(.*?)\./)[1] + "-auth-token");

      // üîí cancella anche dati locali del tool (prefisso tuo)
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith('parfum-formulator:')) localStorage.removeItem(k);
      });

      // nascondi sezioni private + svuota liste
      applyPrivacyUI(false);

      // toast
      const toast = document.createElement("div");
      toast.textContent = "Sei uscito ‚úÖ";
      Object.assign(toast.style, {
        position: "fixed", bottom: "20px", right: "20px",
        background: "#222", color: "#fff", padding: "10px 16px",
        borderRadius: "8px", fontSize: "0.9rem", zIndex: "9999"
      });
      document.body.appendChild(toast);

      setTimeout(() => { location.href = 'https://lorenvitale.github.io/parfum-formulator/'; }, 1000);
    } catch (e) {
      location.href = 'https://lorenvitale.github.io/parfum-formulator/';
    }
  });
</script>
    <script src="app.js"></script>
<script src="assets/batch-mixer.js"></script>
  </body>
</html>
