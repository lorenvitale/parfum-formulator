<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parfum Formulator</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main class="app-shell">
    <header class="hero">
  <div class="logo-box">
    <img src="logo.png" alt="Parfum Calculator Logo" class="site-logo" />
    <p>
      Disegna, valuta e perfeziona le tue formule in modo intuitivo, sempre con
      una visione chiara della piramide olfattiva.
    </p>
  </div>
  <div class="hero-actions">
          <!-- üîπ LOGIN/LOGOUT PATCH -->
          <a
            id="loginLink"
            class="ghost-btn"
            href="./cloud/auth.html?return=https%3A%2F%2Florenvitale.github.io%2Fparfum-formulator%2F"
          >
            Login / Registrati
          </a>
          <span id="userBox" class="microcopy" style="display:none;"></span>
          <button id="logoutBtn" class="ghost-btn" type="button" style="display:none;">Logout</button>

          <!-- üîπ BOTTONI ORIGINALI -->
          <button id="newFormulaBtn" class="ghost-btn" type="button">Nuova formula</button>
          <button
            id="themeToggle"
            class="theme-toggle"
            type="button"
            role="switch"
            aria-checked="false"
            aria-label="Attiva modalit√† scura"
          >
            <span class="theme-toggle__icon" data-icon="sun" aria-hidden="true">‚òÄÔ∏è</span>
            <span class="theme-toggle__track" aria-hidden="true">
              <span class="theme-toggle__thumb"></span>
            </span>
            <span class="theme-toggle__icon" data-icon="moon" aria-hidden="true">üåô</span>
          </button>
        </div>
      </header>

      <!-- üîπ SEZIONE BATCH -->
      <section class="card" id="batchSection">
        <h2>Dosaggio Batch</h2>
        <div class="grid">
          <label class="field">
            <span>Nome Formula</span>
            <input id="formulaName" type="text" placeholder="Es. Aurora" />
          </label>
          <label class="field">
            <span>Tipologia</span>
            <select id="formulaType">
              <option value="EDT">Eau de Toilette</option>
              <option value="EDP" selected>Eau de Parfum</option>
              <option value="Parfum">Extrait / Parfum</option>
              <option value="Cologne">Cologne</option>
            </select>
          </label>
          <label class="field">
            <span>Lotto (g)</span>
            <input id="batchWeight" type="number" min="0" step="0.01" value="100" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Densit√† media (g/ml)</span>
            <input id="density" type="number" min="0.1" step="0.01" value="0.94" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Lotto (ml)</span>
            <output id="batchVolume">106.38</output>
          </label>
          <label class="field">
            <span>Lotto (gocce)</span>
            <output id="batchDrops">2127</output>
          </label>
        </div>
        <p class="microcopy">
          Conversioni basate su 1 ml = densit√† inserita e 20 gocce per millilitro.
        </p>
      </section>

      <!-- üîπ SEZIONE MATERIE PRIME -->
      <section class="card" id="materialsSection">
        <div class="section-header">
          <h2>Materie Prime</h2>
          <div class="section-actions">
            <button id="addMaterialBtn" type="button">Aggiungi nota</button>
            <button id="clearMaterialsBtn" class="ghost-btn" type="button">Svuota</button>
          </div>
        </div>
        <div class="materials-table" id="materialsTable"></div>
        <p class="microcopy">
          Inserisci le note aromatiche in grammi. Le conversioni in ml, gocce e percentuali
          sono calcolate automaticamente rispetto al lotto.
        </p>
      </section>

      <!-- üîπ SEZIONE ANALISI -->
      <section class="card" id="insightsSection">
        <h2>Analisi automatica</h2>
        <div class="insights-grid">
          <div>
            <h3>Piramide olfattiva</h3>
            <ul id="pyramidList" class="pyramid"></ul>
          </div>
          <div>
            <h3>Famiglia predominante</h3>
            <p id="familyBadge" class="badge">-</p>
          </div>
          <div>
            <h3>Bilanciamento</h3>
            <p id="scoreValue" class="score">-</p>
          </div>
          <div>
            <h3>Miglioramenti suggeriti</h3>
            <ul id="improvementList" class="suggestions"></ul>
          </div>
        </div>
      </section>

      <!-- üîπ SEZIONE BIBLIOTECA -->
      <section class="card private" id="librarySection">
        <div class="section-header">
          <h2>Biblioteca formule</h2>
          <div class="section-actions private">
            <button id="saveFormulaBtn" type="button">Salva formula</button>
            <button id="exportFormulaBtn" class="ghost-btn" type="button">Esporta JSON</button>
          </div>
        </div>
        <div id="libraryList" class="library"></div>
      </section>

      <!-- üîπ SEZIONE EXPORT -->
      <section class="card export-card" id="exportSection">
        <h2>Esporta report</h2>
        <p class="microcopy">
          Scarica una copia strutturata della formula corrente per condividerla con il tuo team
          o archiviarla offline.
        </p>
        <div class="export-actions">
          <button id="exportExcelBtn" type="button">Esporta Excel</button>
          <button id="exportPdfBtn" class="ghost-btn" type="button">Esporta PDF</button>
        </div>
      </section>

      <footer class="microcopy">
        I dati restano sul tuo dispositivo (localStorage). Esporta per condividere o archiviare.
      </footer>
    </main>

    <!-- üîπ TEMPLATE -->
    <template id="materialRowTemplate">
      <div class="material-row">
        <div class="material-main">
          <label class="field">
            <span>Nota</span>
            <input type="text" class="note-input" list="noteLibrary" placeholder="Seleziona" />
          </label>
        </div>
        <div class="material-amounts">
          <label class="field">
            <span>Grammi</span>
            <input type="number" class="grams-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Millilitri</span>
            <input type="number" class="ml-input" min="0" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Gocce</span>
            <input type="number" class="drops-input" min="0" step="1" inputmode="numeric" />
          </label>
          <label class="field">
            <span>%</span>
            <input type="number" class="percent-input" min="0" max="100" step="0.01" inputmode="decimal" />
          </label>
          <label class="field">
            <span>Diluizione (%)</span>
            <input type="number" class="dilution-input" min="0" max="100" step="0.1" inputmode="decimal" />
          </label>
        </div>
        <button type="button" class="icon-btn remove-btn" aria-label="Rimuovi nota">‚úï</button>
      </div>
    </template>

    <datalist id="noteLibrary"></datalist>

    <!-- JS originali -->
    <script type="module" src="app.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://xbduxfvclbcdezegvpwl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiZHV4ZnZjbGJjZGV6ZWd2cHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODI5MzEsImV4cCI6MjA3NDk1ODkzMX0.l7d4dqzeoUx4isDRfG2riWDSkP6n2mtaD2kEHtyIudU";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // helper per mostrare/nascondere sezioni private e pulire liste
  function applyPrivacyUI(isLoggedIn) {
    const privates = document.querySelectorAll('.private');
    privates.forEach(el => el.style.display = isLoggedIn ? '' : 'none');
    if (!isLoggedIn) {
      // svuota elenco formule in UI
      document.getElementById('libraryList')?.replaceChildren();
    }
  }

  (async () => {
    const { data: { session } } = await supa.auth.getSession();
    const isLogged = !!session?.user;

    // UI login/logout
    const loginLink = document.getElementById('loginLink');
    const userBox   = document.getElementById('userBox');
    const logoutBtn = document.getElementById('logoutBtn');
    if (isLogged) {
      if (loginLink) loginLink.style.display = 'none';
      if (userBox)   { userBox.style.display = 'inline'; userBox.textContent = `Ciao, ${session.user.email}`; }
      if (logoutBtn) logoutBtn.style.display = 'inline';
    } else {
      if (loginLink) loginLink.style.display = 'inline-block';
      if (userBox)   userBox.style.display = 'none';
      if (logoutBtn) logoutBtn.style.display = 'none';
    }

    // Privacy: mostra/nascondi aree sensibili
    applyPrivacyUI(isLogged);

    // Se cambia lo stato (login/logout da un‚Äôaltra pagina), aggiorna
    supa.auth.onAuthStateChange((_e, sess) => applyPrivacyUI(!!sess?.user));
  })();

  // Logout con pulizia ‚Äúriservata‚Äù
  document.getElementById('logoutBtn')?.addEventListener('click', async () => {
    try {
      await supa.auth.signOut();

      // cancella token supabase locale
      sessionStorage.clear();
      localStorage.removeItem("sb-" + SUPABASE_URL.match(/https:\/\/(.*?)\./)[1] + "-auth-token");

      // üîí cancella anche dati locali del tool (prefisso tuo)
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith('parfum-formulator:')) localStorage.removeItem(k);
      });

      // nascondi sezioni private + svuota liste
      applyPrivacyUI(false);

      // toast
      const toast = document.createElement("div");
      toast.textContent = "Sei uscito ‚úÖ";
      Object.assign(toast.style, {
        position: "fixed", bottom: "20px", right: "20px",
        background: "#222", color: "#fff", padding: "10px 16px",
        borderRadius: "8px", fontSize: "0.9rem", zIndex: "9999"
      });
      document.body.appendChild(toast);

      setTimeout(() => { location.href = 'https://lorenvitale.github.io/parfum-formulator/'; }, 1000);
    } catch (e) {
      location.href = 'https://lorenvitale.github.io/parfum-formulator/';
    }
  });
</script>
  </body>
</html>
